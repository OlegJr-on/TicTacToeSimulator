<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Tic Tac Toe Simulation</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 560px; margin: 0 auto; padding: 1.5rem; }
        h1 { margin: 0 0 1rem; font-size: 1.5rem; }
        .error { color: #c00; margin-bottom: 0.5rem; display: none; }
        .error.visible { display: block; }
        .actions { margin-bottom: 1rem; }
        .btn { padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; background: #2563eb; color: #fff; border: none; border-radius: 6px; }
        .btn:hover { background: #1d4ed8; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .card { border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #fafafa; }
        .card h2 { margin: 0 0 0.5rem; font-size: 1rem; font-weight: 600; color: #374151; }
        .status { margin-bottom: 0.75rem; font-size: 0.9rem; }
        .status strong { margin-right: 0.25rem; }
        table.board { border-collapse: collapse; margin: 0.5rem 0; }
        table.board td { border: 1px solid #333; width: 48px; height: 48px; text-align: center; font-size: 24px; background: #fff; }
        .moves { margin-top: 0.5rem; font-size: 0.85rem; max-height: 120px; overflow-y: auto; }
        .moves ul { margin: 0; padding-left: 1.25rem; }
        .moves li { margin: 0.15rem 0; }
        .current-placeholder { color: #6b7280; font-style: italic; }
        .recent-header { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }
        .recent-header h2 { margin: 0; }
        .recent-actions { display: flex; gap: 0.5rem; }
        .recent-actions .btn { background: #6b7280; font-size: 0.875rem; padding: 0.35rem 0.75rem; }
        .recent-actions .btn:hover { background: #4b5563; }
        .recent-list { max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; background: #fff; }
        .recent-list.collapsed { display: none; }
        .recent-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 0.75rem; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        .recent-row:last-child { border-bottom: none; }
        .recent-row .id { font-family: monospace; color: #6b7280; min-width: 10ch; }
        .recent-row .result { font-weight: 500; }
        .recent-row .view-moves { margin-left: auto; font-size: 0.8rem; color: #2563eb; cursor: pointer; background: none; border: none; padding: 0; text-decoration: underline; }
        .recent-row .view-moves:hover { color: #1d4ed8; }
        .recent-row .moves-detail { width: 100%; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee; font-size: 0.8rem; color: #4b5563; }
        .recent-row .moves-detail ul { margin: 0; padding-left: 1rem; }
        .recent-empty { padding: 0.75rem; color: #6b7280; font-style: italic; text-align: center; }
    </style>
</head>
<body>
    <h1>Tic Tac Toe Simulation</h1>
    <p id="error" class="error" style="display: none;"></p>

    <div class="actions">
        <button type="button" id="btnStart" class="btn" onclick="startSimulation()">Start simulation</button>
        <button type="button" id="btnRunAgain" class="btn" style="display: none;" onclick="startSimulation()">Run again</button>
    </div>

    <div class="card" id="currentGameCard">
        <h2>Current game</h2>
        <div id="currentPlaceholder" class="current-placeholder">No simulation running. Click Start simulation.</div>
        <div id="currentGame" style="display: none;">
            <div class="status">
                <strong>Simulation:</strong> <span id="simStatus">-</span>
                <strong>Game:</strong> <span id="gameStatus">-</span>
            </div>
            <table class="board" id="board">
                <tr><td id="c00"></td><td id="c01"></td><td id="c02"></td></tr>
                <tr><td id="c10"></td><td id="c11"></td><td id="c12"></td></tr>
                <tr><td id="c20"></td><td id="c21"></td><td id="c22"></td></tr>
            </table>
            <div class="moves"><strong>Move history</strong><ul id="moves"></ul></div>
        </div>
    </div>

    <div class="card">
        <div class="recent-header">
            <h2>Recent sessions</h2>
            <div class="recent-actions">
                <button type="button" id="btnToggleList" class="btn">Hide</button>
                <button type="button" id="btnClearList" class="btn">Clear list</button>
            </div>
        </div>
        <div id="recentList" class="recent-list">
            <div id="recentEmpty" class="recent-empty">No sessions yet.</div>
            <div id="recentItems"></div>
        </div>
    </div>

    <script>
        const STORAGE_KEY = 'tictactoe.sessions';
        const POLL_MS = 500;

        const btnStart = document.getElementById('btnStart');
        const btnRunAgain = document.getElementById('btnRunAgain');
        const btnToggleList = document.getElementById('btnToggleList');
        const btnClearList = document.getElementById('btnClearList');
        const errorEl = document.getElementById('error');
        const currentPlaceholder = document.getElementById('currentPlaceholder');
        const currentGame = document.getElementById('currentGame');
        const simStatus = document.getElementById('simStatus');
        const gameStatus = document.getElementById('gameStatus');
        const movesEl = document.getElementById('moves');
        const recentList = document.getElementById('recentList');
        const recentEmpty = document.getElementById('recentEmpty');
        const recentItems = document.getElementById('recentItems');

        var pollIntervalId = null;
        var listCollapsed = false;
        var startInProgress = false;

        function showError(msg) {
            const el = document.getElementById('error');
            if (el) { el.textContent = msg || 'Something went wrong.'; el.classList.add('visible'); }
            else { alert(msg || 'Something went wrong.'); }
        }
        function clearError() {
            const el = document.getElementById('error');
            if (el) el.classList.remove('visible');
        }

        function renderBoard(rows) {
            if (!rows) return;
            for (var r = 0; r < 3; r++) {
                for (var c = 0; c < 3; c++) {
                    var cell = document.getElementById('c' + r + c);
                    if (cell) cell.textContent = (rows[r] && rows[r][c]) ? rows[r][c] : '';
                }
            }
        }

        function renderMoves(ul, moves) {
            var listEl = ul || document.getElementById('moves');
            if (!listEl) return;
            listEl.innerHTML = '';
            if (moves && moves.length) {
                moves.forEach(function(m) {
                    var li = document.createElement('li');
                    li.textContent = (m.player || '') + ' at (' + (m.row != null ? m.row : '') + ',' + (m.col != null ? m.col : '') + ')';
                    listEl.appendChild(li);
                });
            }
        }

        function getResultLabel(data) {
            if (!data || !data.game) return 'DRAW';
            const s = data.game.status;
            const w = data.game.winner;
            return (s === 'WIN' && w) ? 'WIN (' + w + ')' : (s || 'DRAW');
        }

        function startSimulation() {
            if (startInProgress) return;
            startInProgress = true;
            try {
                clearError();
                var startBtn = document.getElementById('btnStart');
                var againBtn = document.getElementById('btnRunAgain');
                if (startBtn) startBtn.disabled = true;
                if (againBtn) againBtn.style.display = 'none';
                fetch('/start?json=1', { method: 'POST', headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }, redirect: 'manual' })
                    .then(function(r) {
                        if (r.type === 'opaqueredirect' || r.status === 302) return Promise.reject('Start failed: server returned redirect. Restart the UI service and refresh the page.');
                        if (r.ok) return r.json();
                        return r.text().then(function(t) {
                            try { var j = JSON.parse(t); return Promise.reject(j.error || r.statusText); } catch (_) { return Promise.reject(t || r.statusText); }
                        });
                    })
                    .then(function(data) {
                        var sessionId = data.sessionId;
                        if (!sessionId) throw new Error('No sessionId');
                        var ph = document.getElementById('currentPlaceholder');
                        var cg = document.getElementById('currentGame');
                        var sim = document.getElementById('simStatus');
                        var gam = document.getElementById('gameStatus');
                        if (ph) ph.style.display = 'none';
                        if (cg) cg.style.display = 'block';
                        if (sim) sim.textContent = 'RUNNING';
                        if (gam) gam.textContent = '-';
                        renderBoard(null);
                        renderMoves(document.getElementById('moves'), []);
                        poll(sessionId);
                    })
                    .catch(function(err) {
                        startInProgress = false;
                        showError(typeof err === 'string' ? err : (err && err.message) || 'Failed to start simulation');
                        if (startBtn) startBtn.disabled = false;
                    });
            } catch (e) {
                startInProgress = false;
                showError(e && (e.message || e.toString()) || 'Failed to start');
                var startBtn = document.getElementById('btnStart');
                if (startBtn) startBtn.disabled = false;
            }
        }

        function poll(sessionId) {
            if (pollIntervalId) clearInterval(pollIntervalId);
            function doPoll() {
                fetch('/sessions/' + sessionId + '/state')
                    .then(function(r) { return r.ok ? r.json() : Promise.reject(new Error('Request failed')); })
                    .then(function(data) {
                        clearError();
                        var sim = document.getElementById('simStatus');
                        var gam = document.getElementById('gameStatus');
                        if (sim) sim.textContent = data.simulationStatus || '-';
                        if (data.game) {
                            var s = data.game.status;
                            var w = data.game.winner;
                            if (gam) gam.textContent = (s === 'WIN' && w) ? ('WIN (' + w + ')') : (s || '-');
                            renderBoard(data.game.board && data.game.board.rows);
                            renderMoves(document.getElementById('moves'), data.moves);
                        }
                        if (data.simulationStatus === 'FINISHED' || data.simulationStatus === 'FAILED') {
                            startInProgress = false;
                            if (pollIntervalId) clearInterval(pollIntervalId);
                            pollIntervalId = null;
                            addToRecent(sessionId, data);
                            renderRecentList();
                            var sb = document.getElementById('btnStart');
                            var rb = document.getElementById('btnRunAgain');
                            if (sb) sb.disabled = false;
                            if (rb) rb.style.display = 'inline-block';
                        }
                    })
                    .catch(function() { showError('Could not load session state. Retrying...'); });
            }
            doPoll();
            pollIntervalId = setInterval(doPoll, POLL_MS);
        }

        function addToRecent(sessionId, data) {
            const result = getResultLabel(data);
            const moves = (data.moves || []).slice();
            let list = [];
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                if (raw) list = JSON.parse(raw);
            } catch (_) {}
            list.unshift({ sessionId, result, moves });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(list));
        }

        function getRecentList() {
            try {
                const raw = localStorage.getItem(STORAGE_KEY);
                return raw ? JSON.parse(raw) : [];
            } catch (_) {
                return [];
            }
        }

        function renderRecentList() {
            var list = getRecentList();
            var emptyEl = document.getElementById('recentEmpty');
            var itemsEl = document.getElementById('recentItems');
            if (emptyEl) emptyEl.style.display = list.length ? 'none' : 'block';
            if (itemsEl) itemsEl.innerHTML = '';
            list.forEach((entry, idx) => {
                const row = document.createElement('div');
                row.className = 'recent-row';
                row.innerHTML = '<span class="id">' + (entry.sessionId || '').slice(0, 8) + 'â€¦</span><span class="result">' + (entry.result || 'DRAW') + '</span><button type="button" class="view-moves" data-idx="' + idx + '">View moves</button>';
                const movesDetail = document.createElement('div');
                movesDetail.className = 'moves-detail';
                movesDetail.style.display = 'none';
                const ul = document.createElement('ul');
                (entry.moves || []).forEach(m => {
                    const li = document.createElement('li');
                    li.textContent = (m.player || '') + ' at (' + (m.row ?? '') + ',' + (m.col ?? '') + ')';
                    ul.appendChild(li);
                });
                movesDetail.appendChild(ul);
                row.appendChild(movesDetail);
                var vm = row.querySelector('.view-moves');
                if (vm) vm.addEventListener('click', function() {
                    var show = movesDetail.style.display !== 'block';
                    movesDetail.style.display = show ? 'block' : 'none';
                });
                if (itemsEl) itemsEl.appendChild(row);
            });
        }

        function toggleList() {
            listCollapsed = !listCollapsed;
            var rl = document.getElementById('recentList');
            var bt = document.getElementById('btnToggleList');
            if (rl) rl.classList.toggle('collapsed', listCollapsed);
            if (bt) bt.textContent = listCollapsed ? 'Show' : 'Hide';
        }

        function clearList() {
            localStorage.removeItem(STORAGE_KEY);
            renderRecentList();
        }

        if (btnStart) btnStart.addEventListener('click', startSimulation);
        if (btnRunAgain) btnRunAgain.addEventListener('click', startSimulation);
        if (btnToggleList) btnToggleList.addEventListener('click', toggleList);
        if (btnClearList) btnClearList.addEventListener('click', clearList);

        renderRecentList();
    </script>
</body>
</html>
